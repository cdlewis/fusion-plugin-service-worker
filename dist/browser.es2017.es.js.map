{"version":3,"file":"browser.es2017.es.js","sources":["../src/browser.js","../src/tokens.js","../src/server.js","../src/handlers.js","../src/index.js"],"sourcesContent":["// @flow\n\n/* global window */\n\nimport {createPlugin} from 'fusion-core';\nimport type {FusionPlugin} from 'fusion-core';\n\nexport default ((createPlugin({\n  middleware() {\n    return (ctx, next) => {\n      if ('serviceWorker' in window.navigator) {\n        window.addEventListener('load', function register() {\n          const sw = window.navigator.serviceWorker;\n          sw\n            .register('/sw.js')\n            /* eslint-disable-next-line no-console */\n            .then(res => console.log('*** sw registered:', res))\n            /* eslint-disable-next-line no-console */\n            .catch(e => console.log('*** sw registration failed:', e));\n        });\n      }\n      return next();\n    };\n  },\n}): any): FusionPlugin<{}, void>);\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport {createToken} from 'fusion-core';\n\nimport type {ConfigTokenType} from './types.js';\n\nexport const SWTemplateFunctionToken: ConfigTokenType = createToken(\n  'SWTemplateFunctionToken'\n);\n","// @flow\n\n/* global */\n\nimport {createPlugin} from 'fusion-core';\nimport type {FusionPlugin} from 'fusion-core';\n\nimport {SWTemplateFunctionToken} from './tokens';\n\nfunction invokeTemplateFn(templateFn, resources) {\n  return templateFn(resources);\n}\n\nexport default ((__NODE__ &&\n  createPlugin({\n    deps: {\n      templateFn: SWTemplateFunctionToken,\n    },\n\n    middleware: ({templateFn}) => {\n      return async (ctx, next) => {\n        if (__NODE__) {\n          if (ctx.method === 'GET' && ctx.url === '/sw.js') {\n            const chunkUrls = Array.from(ctx.chunkUrlMap).map(value =>\n              value[1].get('es5')\n            );\n            try {\n              ctx.type = 'text/javascript';\n              ctx.set('Cache-Control', 'max-age=0');\n              ctx.body = invokeTemplateFn(templateFn, {\n                // TODO(#24): use correct values\n                precachePaths: chunkUrls,\n                cacheablePaths: chunkUrls,\n              });\n            } catch (e) {\n              // TODO(#25): do something maybe\n            }\n          }\n          return next();\n        }\n      };\n    },\n  }): any): FusionPlugin<{}, void>);\n","// @flow\n\n/* eslint-env serviceworker */\n/* globals location, URL, fetch,  */\n\nimport type {AssetInfo} from './types';\n\nconst cacheName = '0.0.0'; // we don't expect this to change\n\nexport default function getHandlers(assetInfo: AssetInfo) {\n  const {precachePaths, cacheablePaths} = assetInfo;\n  return {\n    onInstall: (event: InstallEvent) => {\n      self.skipWaiting();\n      event.waitUntil(\n        // remove old cache\n        caches\n          .open(cacheName)\n          .then(cache => {\n            return cache\n              .addAll(precachePaths)\n              .then(() =>\n                getOutdatedKeys(cache, cacheablePaths).then(outdatedKeys =>\n                  removeKeys(cache, outdatedKeys)\n                )\n              );\n          })\n          .catch(e => {\n            throw new Error(`sw: error updating cache ${cacheName}: ${e}`);\n          })\n      );\n    },\n    onFetch: (event: FetchEvent) => {\n      const HTML_TTL = 1 * 24 * 60 * 60 * 1001; // 1 day\n      const expectsHtml = requestExpectsHtml(event.request);\n      if (\n        !expectsHtml &&\n        !cacheablePaths.includes(new URL(event.request.url).pathname)\n      ) {\n        // bypass service worker, use network\n        return;\n      }\n      const p = caches.match(event.request).then(cachedResponse => {\n        if (cachedResponse) {\n          if (expectsHtml) {\n            const responseCreated = new Date(\n              cachedResponse.headers.get('date') || 0\n            ).valueOf();\n            if (Date.now() - responseCreated > HTML_TTL) {\n              // html expired: use the cache, but refresh cache for next time\n              fetchNCache(event.request, expectsHtml);\n            }\n          }\n          return cachedResponse;\n        }\n        return fetchNCache(event.request, expectsHtml);\n      });\n      event.respondWith(p);\n      event.waitUntil(p);\n    },\n  };\n}\n\nfunction getOutdatedKeys(cache, cacheablePaths) {\n  return cache.keys().then(requests =>\n    requests.filter(request => {\n      return !cacheablePaths.find(key => {\n        return location.origin + key === request.url;\n      });\n    })\n  );\n}\n\nfunction removeKeys(cache, keys) {\n  return Promise.all(keys.map(key => cache.delete(key)));\n}\n\nfunction fetchNCache(request, expectsHtml) {\n  return fetch(request).then(resp => {\n    if (resp.status !== 200) {\n      return Promise.resolve(resp);\n    }\n    const clonedResponse = resp.clone();\n    caches.open(cacheName).then(cache => {\n      if (expectsHtml) {\n        // check we got html before caching\n        if (!responseIsHtml(clonedResponse)) {\n          return Promise.resolve(resp);\n        }\n      }\n      cache.put(request.url, clonedResponse);\n    });\n    return Promise.resolve(resp);\n  });\n}\n\nfunction requestExpectsHtml(request) {\n  if (!request || !request.headers) {\n    return false;\n  }\n  const acceptHeader = request.headers.get('Accept');\n  return acceptHeader && acceptHeader.indexOf('html') > -1;\n}\n\nfunction responseIsHtml(response) {\n  if (!response || !response.headers) {\n    return false;\n  }\n  const contentType = response.headers.get('content-type');\n  return contentType && contentType.indexOf('html') > -1;\n}\n","// @flow\n\nimport browserPlugin from './browser';\nimport serverPlugin from './server';\nimport getHandlers from './handlers';\nimport {SWTemplateFunctionToken} from './tokens';\n\nexport default (__NODE__ ? serverPlugin : browserPlugin);\nexport {getHandlers, SWTemplateFunctionToken};\n"],"names":["createPlugin","middleware","ctx","next","window","navigator","addEventListener","register","sw","serviceWorker","then","res","console","log","catch","e","SWTemplateFunctionToken","createToken","cacheName","getHandlers","assetInfo","precachePaths","cacheablePaths","onInstall","event","self","skipWaiting","waitUntil","caches","open","cache","addAll","getOutdatedKeys","outdatedKeys","removeKeys","Error","onFetch","HTML_TTL","expectsHtml","requestExpectsHtml","request","includes","URL","url","pathname","p","match","cachedResponse","responseCreated","Date","headers","get","valueOf","now","fetchNCache","respondWith","keys","requests","filter","find","key","location","origin","Promise","all","map","delete","fetch","resp","status","resolve","clonedResponse","clone","responseIsHtml","put","acceptHeader","indexOf","response","contentType","browserPlugin"],"mappings":"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"}